<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyAnnote Test Results Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 50px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .audio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .audio-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .audio-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speaker-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            color: white;
        }

        .speaker-00 {
            background: #667eea;
        }

        .speaker-01 {
            background: #f093fb;
        }

        .audio-player {
            width: 100%;
            margin-top: 10px;
        }

        .audio-player audio {
            width: 100%;
            outline: none;
        }

        .transcript-section {
            margin-top: 30px;
        }

        .transcript-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
        }

        .transcript-segment {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .time-stamp {
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .transcript-text {
            margin-top: 10px;
            line-height: 1.6;
            color: #333;
        }

        .info-badge {
            display: inline-block;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        .test-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ PyAnnote Test Results Dashboard</h1>
            <p>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è —Å–ø—ñ–∫–µ—Ä—ñ–≤</p>
        </div>

        <div class="content">
            <div id="loading" class="loading">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Ç–µ—Å—Ç—ñ–≤...
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="dashboard"></div>
        </div>
    </div>

    <script>
        async function loadTestResults() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');

            try {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—ñ–≤
                const response = await fetch('pyannote_test_results.json');
                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${response.status}`);
                }
                
                const testResults = await response.json();
                renderDashboard(testResults);
            } catch (err) {
                // –Ø–∫—â–æ —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, —Å–ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ø—Ä—è–º—É –∑ /tmp
                console.log('Trying to load from individual test files...');
                await loadIndividualTests();
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadIndividualTests() {
            const dashboard = document.getElementById('dashboard');
            const error = document.getElementById('error');
            
            const testFiles = [
                { path: '../tmp/test_response.json', name: 'Call center 1.wav' },
                { path: '../tmp/test_response2.json', name: 'OverlappingCallCenterWithoutBackground.MP3' }
            ];

            const testResults = [];

            for (const testFile of testFiles) {
                try {
                    const response = await fetch(testFile.path);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            testResults.push({
                                name: testFile.name,
                                data: data
                            });
                        }
                    }
                } catch (e) {
                    console.log(`Could not load ${testFile.path}:`, e);
                }
            }

            if (testResults.length > 0) {
                renderDashboard(testResults);
            } else {
                error.style.display = 'block';
                error.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—ñ–≤. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ñ–∞–π–ª–∏ —Ç–µ—Å—Ç—ñ–≤ –¥–æ—Å—Ç—É–ø–Ω—ñ.';
            }
        }

        function renderDashboard(testResults) {
            const dashboard = document.getElementById('dashboard');
            
            if (!testResults || testResults.length === 0) {
                dashboard.innerHTML = '<div class="no-data">–ù–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Ç–µ—Å—Ç—ñ–≤</div>';
                return;
            }

            let html = '';

            testResults.forEach((test, testIndex) => {
                const testData = test.data;
                const testName = test.name || `Test ${testIndex + 1}`;
                
                html += `<div class="test-section">`;
                html += `<h2 class="test-title">${escapeHtml(testName)}</h2>`;
                
                // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ç–µ—Å—Ç
                html += `<div class="test-info">`;
                html += `<span class="info-badge">–†–µ–∂–∏–º: ${escapeHtml(testData.pipelineMode || 'mode2')}</span>`;
                html += `<span class="info-badge">–£—Å–ø—ñ—à–Ω–æ: ${testData.success ? '‚úÖ' : '‚ùå'}</span>`;
                if (testData.separation) {
                    html += `<span class="info-badge">–°–ø—ñ–∫–µ—Ä—ñ–≤: ${testData.separation.speakers?.length || 0}</span>`;
                }
                html += `</div>`;

                // –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∞—É–¥—ñ–æ (—à—É–∫–∞—î–º–æ –≤ —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö)
                let originalAudio = null;
                let originalFileName = null;
                
                // –í–∞—Ä—ñ–∞–Ω—Ç 1: –∑ –Ω–∞–∑–≤–∏ —Ç–µ—Å—Ç—É
                const testName = test.name || '';
                if (testName.includes('.wav') || testName.includes('.mp3') || testName.includes('.WAV') || testName.includes('.MP3')) {
                    originalFileName = testName;
                }
                // –í–∞—Ä—ñ–∞–Ω—Ç 2: –∑ primaryDiarization
                else if (testData.primaryDiarization?.recordings?.[0]?.name) {
                    const recName = testData.primaryDiarization.recordings[0].name;
                    if (recName.includes('.wav') || recName.includes('.mp3') || recName.includes('.WAV') || recName.includes('.MP3')) {
                        originalFileName = recName;
                    }
                }
                // –í–∞—Ä—ñ–∞–Ω—Ç 3: –∑ fileName
                else if (testData.primaryDiarization?.recordings?.[0]?.fileName) {
                    const fileName = testData.primaryDiarization.recordings[0].fileName;
                    // –Ø–∫—â–æ —Ü–µ –Ω–µ —Ö–µ—à (–¥–æ–≤–∂–∏–Ω–∞ > 20), –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —è–∫ —î
                    if (fileName.length > 20 && (fileName.includes('.wav') || fileName.includes('.mp3'))) {
                        originalFileName = fileName;
                    }
                }
                
                // –§–æ—Ä–º—É—î–º–æ URL –¥–ª—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª—É
                if (originalFileName) {
                    // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ –≤ audio examples (–∑ –ø—Ä–æ–±—ñ–ª–∞–º–∏)
                    // –ö–æ–¥—É—î–º–æ –≤–µ—Å—å —à–ª—è—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                    const fullPath = `audio examples/${originalFileName}`;
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ encodeURI –¥–ª—è –≤—Å—å–æ–≥–æ —à–ª—è—Ö—É (–∫–æ–¥—É—î –ø—Ä–æ–±—ñ–ª–∏ —è–∫ %20)
                    const encodedPath = encodeURI(fullPath);
                    originalAudio = `http://localhost:3000/${encodedPath}`;
                } else if (testData.sourceAudio) {
                    originalAudio = testData.sourceAudio;
                }
                
                if (originalAudio) {
                    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —à–ª—è—Ö –≤ localhost URL —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
                    let audioUrl = originalAudio;
                    if (!audioUrl.startsWith('http://') && !audioUrl.startsWith('https://')) {
                        if (audioUrl.startsWith('/uploads/') || audioUrl.startsWith('/')) {
                            audioUrl = `http://localhost:3000${audioUrl}`;
                        } else {
                            audioUrl = `http://localhost:3000/uploads/${audioUrl}`;
                        }
                    }
                    
                    html += `<div class="audio-card" style="grid-column: 1 / -1;">`;
                    html += `<div class="audio-label">üéµ –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ –∑–∞–ø–∏—Å: ${escapeHtml(originalFileName || 'Original')}</div>`;
                    html += `<div class="audio-player">`;
                    html += `<audio controls><source src="${audioUrl}" type="audio/${originalFileName?.split('.').pop() || 'wav'}"></audio>`;
                    html += `</div></div>`;
                }

                // –†–æ–∑–¥—ñ–ª–µ–Ω—ñ –¥–æ—Ä—ñ–∂–∫–∏
                if (testData.separation && testData.separation.speakers) {
                    html += `<div class="audio-grid">`;
                    
                    testData.separation.speakers.forEach((speaker, index) => {
                        const speakerName = speaker.name || `SPEAKER_${index.toString().padStart(2, '0')}`;
                        const speakerNum = speakerName.replace('SPEAKER_', '');
                        const speakerUrl = speaker.downloadUrl || speaker.url;
                        
                        html += `<div class="audio-card">`;
                        html += `<div class="audio-label">`;
                        html += `<span class="speaker-badge speaker-${speakerNum % 2}">${escapeHtml(speakerName)}</span>`;
                        html += `</div>`;
                        html += `<div class="audio-player">`;
                        
                        if (speakerUrl) {
                            // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ URL —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
                            let audioUrl = speakerUrl;
                            
                            // –Ø–∫—â–æ —Ü–µ localtunnel URL, –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ localhost
                            if (speakerUrl.includes('loca.lt') || speakerUrl.includes('ngrok') || speakerUrl.includes('tunnel')) {
                                // –í–∏—Ç—è–≥—É—î–º–æ —à–ª—è—Ö –∑ URL
                                try {
                                    const url = new URL(speakerUrl);
                                    audioUrl = `http://localhost:3000${url.pathname}`;
                                } catch (e) {
                                    // –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏, —Å–ø—Ä–æ–±—É—î–º–æ –≤–∏—Ç—è–≥—Ç–∏ —à–ª—è—Ö –≤—Ä—É—á–Ω—É
                                    const pathMatch = speakerUrl.match(/\/uploads\/[^\/]+$/);
                                    if (pathMatch) {
                                        audioUrl = `http://localhost:3000${pathMatch[0]}`;
                                    }
                                }
                            }
                            // –Ø–∫—â–æ —Ü–µ —ñ–Ω—à–∏–π HTTP URL, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —è–∫ —î
                            else if (speakerUrl.startsWith('http://') || speakerUrl.startsWith('https://')) {
                                audioUrl = speakerUrl;
                            }
                            // –Ø–∫—â–æ —Ü–µ –ª–æ–∫–∞–ª—å–Ω–∏–π —à–ª—è—Ö /uploads/, –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ localhost
                            else if (speakerUrl.startsWith('/uploads/')) {
                                audioUrl = `http://localhost:3000${speakerUrl}`;
                            }
                            // –Ø–∫—â–æ —Ü–µ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö
                            else if (speakerUrl.startsWith('/')) {
                                audioUrl = `http://localhost:3000${speakerUrl}`;
                            }
                            // –Ø–∫—â–æ —Ü–µ –≤—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –±–µ–∑ —Å–ª–µ—à—É
                            else {
                                audioUrl = `http://localhost:3000/uploads/${speakerUrl}`;
                            }
                            
                            html += `<audio controls><source src="${audioUrl}" type="audio/${speaker.format || 'wav'}"></audio>`;
                        } else {
                            html += `<div class="no-data">URL –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`;
                        }
                        
                        html += `</div></div>`;
                    });
                    
                    html += `</div>`;
                }

                // –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏ (—è–∫—â–æ —î)
                const transcripts = extractTranscripts(testData);
                if (transcripts && transcripts.length > 0) {
                    html += `<div class="transcript-section">`;
                    html += `<h3 class="transcript-title">üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏</h3>`;
                    
                    transcripts.forEach(segment => {
                        const speaker = segment.speaker || 'UNKNOWN';
                        const speakerNum = speaker.replace('SPEAKER_', '');
                        html += `<div class="transcript-segment">`;
                        html += `<span class="speaker-badge speaker-${speakerNum % 2}">${escapeHtml(speaker)}</span>`;
                        if (segment.start !== undefined && segment.end !== undefined) {
                            html += `<span class="time-stamp">${formatTime(segment.start)} - ${formatTime(segment.end)}</span>`;
                        }
                        html += `<div class="transcript-text">${escapeHtml(segment.text || segment.originalText || '')}</div>`;
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                } else {
                    html += `<div class="transcript-section">`;
                    html += `<h3 class="transcript-title">üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏</h3>`;
                    html += `<div class="no-data">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ç–µ—Å—Ç—É</div>`;
                    html += `</div>`;
                }

                html += `</div>`;
            });

            dashboard.innerHTML = html;
        }

        function extractTranscripts(testData) {
            // –®—É–∫–∞—î–º–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
            const segments = [];
            
            // –í–∞—Ä—ñ–∞–Ω—Ç 1: correctedDiarization (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç, –±–æ —Ü–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏)
            if (testData.correctedDiarization?.recordings?.[0]?.results) {
                const results = testData.correctedDiarization.recordings[0].results;
                for (const [serviceName, serviceData] of Object.entries(results)) {
                    if (serviceData?.segments && Array.isArray(serviceData.segments)) {
                        segments.push(...serviceData.segments);
                    }
                }
            }
            
            // –í–∞—Ä—ñ–∞–Ω—Ç 2: primaryDiarization (—è–∫—â–æ –Ω–µ–º–∞—î corrected)
            if (segments.length === 0 && testData.primaryDiarization?.recordings?.[0]?.results) {
                const results = testData.primaryDiarization.recordings[0].results;
                for (const [serviceName, serviceData] of Object.entries(results)) {
                    if (serviceData?.segments && Array.isArray(serviceData.segments)) {
                        segments.push(...serviceData.segments);
                    }
                }
            }
            
            // –í–∞—Ä—ñ–∞–Ω—Ç 3: –Ω–∞–ø—Ä—è–º—É –≤ recording
            if (segments.length === 0 && testData.recordings?.[0]?.results) {
                const results = testData.recordings[0].results;
                for (const [serviceName, serviceData] of Object.entries(results)) {
                    if (serviceData?.segments && Array.isArray(serviceData.segments)) {
                        segments.push(...serviceData.segments);
                    }
                }
            }
            
            return segments.length > 0 ? segments : null;
        }

        function getAudioUrl(fileName) {
            if (!fileName) return null;
            
            // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ —Ñ–∞–π–ª –≤ —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö
            const possiblePaths = [
                `../uploads/${fileName}`,
                `../audio examples/${fileName}`,
                `uploads/${fileName}`,
                `audio examples/${fileName}`,
                fileName
            ];
            
            return possiblePaths[0];
        }

        function formatTime(seconds) {
            if (seconds === undefined || seconds === null) return 'N/A';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('DOMContentLoaded', loadTestResults);
    </script>
</body>
</html>

