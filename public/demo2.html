<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–π–ø–ª–∞–π–Ω</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        h1 {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #66BB6A;
            margin-top: 20px;
        }
        #fileStatus, #pollingStatus {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #444;
            color: #e0e0e0;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            background-color: #2d2d2d;
            color: #e0e0e0;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            cursor: pointer;
        }
        input[type="file"]::file-selector-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #45a049;
        }
        #dialogueResult, #llmProgress {
            margin-top: 20px;
            padding: 15px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
        }
        @media (prefers-color-scheme: light) {
            body { background-color: #ffffff; color: #000000; }
            h1 { color: #2E7D32; border-bottom: 2px solid #2E7D32; }
            h2 { color: #388E3C; }
            #fileStatus, #pollingStatus { background-color: #f5f5f5; border: 1px solid #ddd; color: #000000; }
            input[type="file"] { background-color: #ffffff; color: #000000; }
            #dialogueResult, #llmProgress { background-color: #f5f5f5; border: 1px solid #ddd; color: #000000; }
        }
    </style>
</head>
<body>
    <h1>–ü–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–æ–±–∫–∏</h1>
    
    <div>
        <h2>–ö—Ä–æ–∫ 1: –î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª</h2>
        <input type="file" id="fileInput" accept="audio/*" />
        <div id="fileStatus"></div>
    </div>

    <div id="pollingStatus" style="margin-top: 20px;"></div>

    <script>
        let selectedFile = null;
        let fileBase64 = null;
        const SERVER_URL = 'http://100.67.135.103:5005';
        const NODE_SERVER_URL = window.location.origin || 'http://localhost:3000';

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                selectedFile = file;
                document.getElementById('fileStatus').innerHTML = 
                    '–§–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ:<br>' +
                    '–ù–∞–∑–≤–∞: ' + file.name + '<br>' +
                    '–†–æ–∑–º—ñ—Ä: ' + (file.size / 1024).toFixed(2) + ' KB<br>' +
                    '–¢–∏–ø: ' + file.type + '<br>' +
                    '<span style="color: orange;">–ö–æ–¥—É–≤–∞–Ω–Ω—è –≤ base64...</span>';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileBase64 = e.target.result;
                    document.getElementById('fileStatus').innerHTML = 
                        '–§–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ:<br>' +
                        '–ù–∞–∑–≤–∞: ' + file.name + '<br>' +
                        '–†–æ–∑–º—ñ—Ä: ' + (file.size / 1024).toFixed(2) + ' KB<br>' +
                        '–¢–∏–ø: ' + file.type + '<br>' +
                        '<span style="color: green;">‚úì –ó–∞–∫–æ–¥–æ–≤–∞–Ω–æ –≤ base64</span><br>' +
                        '<span style="color: orange;">–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...</span>';
                    console.log('–§–∞–π–ª –∑–∞–∫–æ–¥–æ–≤–∞–Ω–æ –≤ base64');
                    
                    sendToServer(fileBase64, file.name);
                };
                reader.readAsDataURL(file);
            } else {
                selectedFile = null;
                fileBase64 = null;
                document.getElementById('fileStatus').innerHTML = '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
            }
            
            event.target.value = '';
        });

        async function sendToServer(base64Data, filename) {
            console.log('–°–ø—Ä–æ–±–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –Ω–∞:', SERVER_URL + '/api/diarize');
            console.log('–ù–∞–∑–≤–∞ —Ñ–∞–π–ª—É:', filename);
            
            try {
                const response = await fetch(SERVER_URL + '/api/diarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file: base64Data, filename: filename })
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('–í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:', result);
                    
                    let jobId = null;
                    let statusMessage = '';
                    
                    if (result.success === false) {
                        const errorMsg = result.error || 'Unknown error';
                        statusMessage = '<span style="color: red;">‚úó Error: ' + errorMsg + '</span>';
                        console.error('Error from server:', errorMsg);
                    } else if (result.success === true && result.job_id) {
                        jobId = result.job_id;
                        statusMessage = '<span style="color: green;">‚úì Job ID: ' + jobId + '</span>';
                        console.log('Job ID extracted:', jobId);
                        
                        window.currentJobId = jobId;
                        startPolling(jobId);
                    } else {
                        statusMessage = '<span style="color: orange;">‚ö† Unexpected response format</span>';
                        console.warn('Unexpected response:', result);
                    }
                    
                    document.getElementById('fileStatus').innerHTML = 
                        '–§–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ:<br>' +
                        '–ù–∞–∑–≤–∞: ' + selectedFile.name + '<br>' +
                        '–†–æ–∑–º—ñ—Ä: ' + (selectedFile.size / 1024).toFixed(2) + ' KB<br>' +
                        '–¢–∏–ø: ' + selectedFile.type + '<br>' +
                        '<span style="color: green;">‚úì –ó–∞–∫–æ–¥–æ–≤–∞–Ω–æ –≤ base64</span><br>' +
                        '<span style="color: green;">‚úì –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</span><br>' +
                        statusMessage;
                } else {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
                }
            } catch (error) {
                console.error('–ü–æ–≤–Ω–∞ –ø–æ–º–∏–ª–∫–∞:', error);
                document.getElementById('fileStatus').innerHTML = 
                    '–§–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ:<br>' +
                    '–ù–∞–∑–≤–∞: ' + selectedFile.name + '<br>' +
                    '–†–æ–∑–º—ñ—Ä: ' + (selectedFile.size / 1024).toFixed(2) + ' KB<br>' +
                    '–¢–∏–ø: ' + selectedFile.type + '<br>' +
                    '<span style="color: green;">‚úì –ó–∞–∫–æ–¥–æ–≤–∞–Ω–æ –≤ base64</span><br>' +
                    '<span style="color: red;">‚úó –ü–æ–º–∏–ª–∫–∞: ' + error.message + '</span>';
            }
        }

        async function startPolling(jobId) {
            const maxAttempts = 120;
            let attempts = 0;
            const statusUrl = SERVER_URL + '/api/diarize/' + jobId + '/status';
            
            document.getElementById('pollingStatus').innerHTML = 
                '<h2>–ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É</h2>' +
                '<div>Job ID: ' + jobId + '</div>' +
                '<div>–°–ø—Ä–æ–±–∞: 0/' + maxAttempts + '</div>' +
                '<div>–°—Ç–∞—Ç—É—Å: <span style="color: orange;">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span></div>';
            
            const pollInterval = setInterval(async function() {
                attempts++;
                
                try {
                    const response = await fetch(statusUrl);
                    
                    if (response.ok) {
                        const statusData = await response.json();
                        const currentStatus = statusData.status || 'unknown';
                        const statusColor = currentStatus === 'completed' ? 'green' : 'orange';
                        
                        document.getElementById('pollingStatus').innerHTML = 
                            '<h2>–ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É</h2>' +
                            '<div>Job ID: ' + jobId + '</div>' +
                            '<div>–°–ø—Ä–æ–±–∞: ' + attempts + '/' + maxAttempts + '</div>' +
                            '<div>–°—Ç–∞—Ç—É—Å: <span style="color: ' + statusColor + ';">' + currentStatus + '</span></div>';
                        
                        if (currentStatus === 'completed') {
                            clearInterval(pollInterval);
                            document.getElementById('pollingStatus').innerHTML += 
                                '<div style="color: green; margin-top: 10px;">‚úì –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>';
                            await getFormattedDialogue(jobId);
                        }
                    }
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        document.getElementById('pollingStatus').innerHTML += 
                            '<div style="color: red; margin-top: 10px;">‚úó –ú–∞–∫—Å–∏–º—É–º —Å–ø—Ä–æ–±</div>';
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000);
        }

        async function getFormattedDialogue(jobId) {
            const formattedUrl = SERVER_URL + '/api/diarize/' + jobId + '/formatted';
            
            try {
                const response = await fetch(formattedUrl);
                
                if (response.ok) {
                    const formattedResponse = await response.json();
                    const formattedDialogue = formattedResponse.formatted_dialogue || formattedResponse;
                    window.formattedDialogue = formattedDialogue;
                    
                    document.getElementById('pollingStatus').innerHTML += 
                        '<div style="color: green; margin-top: 10px;">‚úì –§–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–∏–π –¥—ñ–∞–ª–æ–≥ –æ—Ç—Ä–∏–º–∞–Ω–æ!</div>' +
                        '<div style="color: orange; margin-top: 5px;">–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∞—É–¥—ñ–æ –¥–ª—è —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è...</div>';
                    
                    await sendAudioForSeparation(jobId);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function sendAudioForSeparation(jobId) {
            try {
                console.log('–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∞—É–¥—ñ–æ –Ω–∞ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è...');
                
                const formData = new FormData();
                formData.append('audio', selectedFile);
                
                const response = await fetch(SERVER_URL + '/api/separate-audio', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –∞—É–¥—ñ–æ:', result);
                    
                    const file1Link = result.file1;
                    const file2Link = result.file2;
                    
                    document.getElementById('pollingStatus').innerHTML += 
                        '<div style="color: green; margin-top: 10px;">‚úì –ê—É–¥—ñ–æ —Ä–æ–∑–¥—ñ–ª–µ–Ω–æ!</div>';
                    
                    displayAudioPlayers(file1Link, file2Link);
                    
                    document.getElementById('pollingStatus').innerHTML += 
                        '<div style="color: orange; margin-top: 10px;">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤...</div>';
                    
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±—É—î–º–æ –∫–æ–∂–µ–Ω —Ñ–∞–π–ª
                    await transcribeSeparatedFiles(file1Link, file2Link);
                } else {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –∞—É–¥—ñ–æ: ' + response.status);
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∞—É–¥—ñ–æ:', error);
                document.getElementById('pollingStatus').innerHTML += 
                    '<div style="color: red; margin-top: 10px;">‚úó –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∞—É–¥—ñ–æ: ' + error.message + '</div>';
            }
        }

        async function transcribeSeparatedFiles(file1Link, file2Link) {
            try {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–∞–π–ª 1
                console.log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É 1:', file1Link);
                const file1Response = await fetch(file1Link);
                const file1Blob = await file1Response.blob();
                const file1 = new File([file1Blob], 'speaker_1.wav', { type: 'audio/wav' });
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–∞–π–ª 2
                console.log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É 2:', file2Link);
                const file2Response = await fetch(file2Link);
                const file2Blob = await file2Response.blob();
                const file2 = new File([file2Blob], 'speaker_2.wav', { type: 'audio/wav' });
                
                document.getElementById('pollingStatus').innerHTML += 
                    '<div style="color: orange; margin-top: 5px;">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—è —Ñ–∞–π–ª—É 1...</div>';
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–∞–π–ª 1 –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—é
                const formData1 = new FormData();
                formData1.append('audio', file1);
                
                const transcribe1Response = await fetch(SERVER_URL + '/api/diarize-and-transcribe', {
                    method: 'POST',
                    body: formData1
                });
                
                if (transcribe1Response.ok) {
                    const file1Result = await transcribe1Response.json();
                    window.File1Transcript = file1Result;
                    console.log('File1Transcript:', file1Result);
                    
                    document.getElementById('pollingStatus').innerHTML += 
                        '<div style="color: green; margin-top: 5px;">‚úì –§–∞–π–ª 1 —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–æ–≤–∞–Ω–æ!</div>' +
                        '<div style="color: orange; margin-top: 5px;">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—è —Ñ–∞–π–ª—É 2...</div>';
                }
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–∞–π–ª 2 –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—é
                const formData2 = new FormData();
                formData2.append('audio', file2);
                
                const transcribe2Response = await fetch(SERVER_URL + '/api/diarize-and-transcribe', {
                    method: 'POST',
                    body: formData2
                });
                
                if (transcribe2Response.ok) {
                    const file2Result = await transcribe2Response.json();
                    window.File2Transcript = file2Result;
                    console.log('File2Transcript:', file2Result);
                    
                    document.getElementById('pollingStatus').innerHTML += 
                        '<div style="color: green; margin-top: 5px;">‚úì –§–∞–π–ª 2 —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–æ–≤–∞–Ω–æ!</div>';
                    
                    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏
                    displayTranscripts(window.File1Transcript, window.File2Transcript);
                    
                    document.getElementById('pollingStatus').innerHTML += 
                        '<div style="color: orange; margin-top: 10px;">–û–±—Ä–æ–±–∫–∞ —á–µ—Ä–µ–∑ LLM...</div>';
                    
                    // –¢–µ–ø–µ—Ä –æ–±—Ä–æ–±–ª—è—î–º–æ —á–µ—Ä–µ–∑ LLM
                    await processDialogueWithLLM(window.formattedDialogue);
                }
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—ó:', error);
                document.getElementById('pollingStatus').innerHTML += 
                    '<div style="color: red; margin-top: 10px;">‚úó –ü–æ–º–∏–ª–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü—ñ—ó: ' + error.message + '</div>';
            }
        }

        function displayTranscripts(file1Transcript, file2Transcript) {
            const transcriptsDiv = document.createElement('div');
            transcriptsDiv.id = 'transcriptsDisplay';
            transcriptsDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #2d2d2d; border: 1px solid #444; border-radius: 8px; color: #e0e0e0;';
            
            transcriptsDiv.innerHTML = 
                '<h2>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏ —Ä–æ–∑–¥—ñ–ª–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤</h2>' +
                '<div style="margin-top: 10px;">' +
                    '<h3>–°–ø—ñ–∫–µ—Ä 1 (File1Transcript):</h3>' +
                    '<div style="background: #1a1a1a; padding: 10px; border-radius: 5px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; font-family: monospace;">' +
                        JSON.stringify(file1Transcript, null, 2) +
                    '</div>' +
                '</div>' +
                '<div style="margin-top: 15px;">' +
                    '<h3>–°–ø—ñ–∫–µ—Ä 2 (File2Transcript):</h3>' +
                    '<div style="background: #1a1a1a; padding: 10px; border-radius: 5px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; font-family: monospace;">' +
                        JSON.stringify(file2Transcript, null, 2) +
                    '</div>' +
                '</div>';
            
            document.body.appendChild(transcriptsDiv);
            
            console.log('Transcripts displayed');
        }

        function displayAudioPlayers(file1Link, file2Link) {
            // –°—Ç–≤–æ—Ä—é—î–º–æ –±–ª–æ–∫ –¥–ª—è –∞—É–¥—ñ–æ –ø–ª–µ—î—Ä—ñ–≤
            const audioDiv = document.createElement('div');
            audioDiv.id = 'audioPlayers';
            audioDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #2d2d2d; border: 1px solid #444; border-radius: 8px; color: #e0e0e0;';
            
            audioDiv.innerHTML = 
                '<h2>–†–æ–∑–¥—ñ–ª–µ–Ω—ñ –∞—É–¥—ñ–æ—Ñ–∞–π–ª–∏</h2>' +
                '<div style="margin-top: 10px;">' +
                    '<h3>–°–ø—ñ–∫–µ—Ä 1:</h3>' +
                    '<audio controls style="width: 100%; margin-top: 5px;">' +
                        '<source src="' + file1Link + '" type="audio/wav">' +
                        '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î audio –µ–ª–µ–º–µ–Ω—Ç.' +
                    '</audio>' +
                '</div>' +
                '<div style="margin-top: 15px;">' +
                    '<h3>–°–ø—ñ–∫–µ—Ä 2:</h3>' +
                    '<audio controls style="width: 100%; margin-top: 5px;">' +
                        '<source src="' + file2Link + '" type="audio/wav">' +
                        '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î audio –µ–ª–µ–º–µ–Ω—Ç.' +
                    '</audio>' +
                '</div>';
            
            document.body.appendChild(audioDiv);
            
            console.log('Audio players displayed');
            console.log('File 1 link:', file1Link);
            console.log('File 2 link:', file2Link);
        }

        async function processDialogueWithLLM(formattedDialogue) {
            try {
                const lines = formattedDialogue.split('\n').filter(function(line) { return line.trim() !== ''; });
                const totalLines = lines.length;
                const dialogueWithRoles = [];
                
                const progressDiv = document.createElement('div');
                progressDiv.id = 'llmProgress';
                progressDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #2d2d2d; border: 1px solid #444; border-radius: 8px; color: #e0e0e0;';
                document.body.appendChild(progressDiv);
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const progress = i + 1;
                    const progressPercent = (progress / totalLines * 100);
                    
                    progressDiv.innerHTML = 
                        '<h2>–û–±—Ä–æ–±–∫–∞ –¥—ñ–∞–ª–æ–≥—É —á–µ—Ä–µ–∑ LLM</h2>' +
                        '<div>–ü—Ä–æ–≥—Ä–µ—Å: ' + progress + ' / ' + totalLines + '</div>' +
                        '<div style="background: #444; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 10px;">' +
                            '<div style="background: #4CAF50; height: 100%; width: ' + progressPercent + '%; transition: width 0.3s;"></div>' +
                        '</div>';
                    
                    const prompt = "You are an expert in analyzing call center dialogues.\n\nCONTEXT:\nYou are analyzing a dialogue from a call center. The dialogue below is provided as REFERENCE ONLY.\n\nFULL DIALOGUE (for context only):\n" + formattedDialogue + "\n\nSPECIFIC REPLICA TO ANALYZE:\n" + line + "\n\nTASK:\n1. Parse the replica line in format: \"MM:SS Speaker X: [text]\"\n2. Extract the timestamp (MM:SS format)\n3. Extract the speaker label (Speaker 0 or Speaker 1)\n4. Extract the text content\n5. Analyze the text content to determine the role:\n   - Agent: call center employee\n   - Client: customer\n6. Replace 'Speaker 0' or 'Speaker 1' with 'Agent' or 'Client'\n7. Return ONLY the modified line in format: MM:SS [role]: [text]\n\nIMPORTANT:\n- Use 'Agent' for call center employees\n- Use 'Client' for customers\n- Return ONLY the modified line, nothing else";
                    
                    const llmResponse = await fetch(NODE_SERVER_URL + '/api/llm/chat-completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            messages: [{ role: 'user', content: prompt }],
                            temperature: 0.1,
                            max_tokens: 200
                        })
                    });
                    
                    if (llmResponse.ok) {
                        const llmData = await llmResponse.json();
                        const processedLine = llmData.choices[0].message.content.trim();
                        dialogueWithRoles.push(processedLine);
                        console.log('Processed line ' + progress + ':', processedLine);
                    } else {
                        // Handle errors, especially 402 Payment Required
                        const errorData = await llmResponse.json().catch(() => ({}));
                        
                        if (llmResponse.status === 402) {
                            console.warn('‚ö†Ô∏è LLM API payment required (402) for line ' + progress + '. Using original line.');
                            dialogueWithRoles.push(line);
                            
                            // Show warning only once
                            if (!window.llmPaymentWarningShown) {
                                window.llmPaymentWarningShown = true;
                                document.getElementById('pollingStatus').innerHTML += 
                                    '<div style="color: orange; margin-top: 10px;">‚ö†Ô∏è LLM API credits exhausted. Processing will continue without role assignment.</div>';
                            }
                        } else {
                            console.error('Failed to process line ' + progress + ':', llmResponse.status, errorData);
                            dialogueWithRoles.push(line);
                        }
                    }
                }
                
                const initialDialogue = dialogueWithRoles.join('\n');
                window.initialDialogue = initialDialogue;
                
                progressDiv.remove();
                
                document.getElementById('pollingStatus').innerHTML += 
                    '<div style="color: green; margin-top: 10px;">‚úì –û–±—Ä–æ–±–∫–∞ —á–µ—Ä–µ–∑ LLM –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>';
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.id = 'dialogueResult';
                dialogueDiv.innerHTML = 
                    '<h2>–§—ñ–Ω–∞–ª—å–Ω–∏–π –¥—ñ–∞–ª–æ–≥ (Initial Dialogue)</h2>' +
                    '<div style="background: #1a1a1a; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; font-family: monospace; color: #e0e0e0; border: 1px solid #444;">' +
                        initialDialogue +
                    '</div>';
                document.body.appendChild(dialogueDiv);
                
                // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–∞ webhook
                await sendToWebhooks();
                
            } catch (error) {
                console.error('Error processing dialogue with LLM:', error);
                document.getElementById('pollingStatus').innerHTML += 
                    '<div style="color: red; margin-top: 10px;">‚úó –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ LLM: ' + error.message + '</div>';
            }
        }

        async function sendToWebhooks() {
            try {
                document.getElementById('pollingStatus').innerHTML += 
                    '<div style="color: orange; margin-top: 10px;">–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö –Ω–∞ webhook...</div>';
                
                // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä –¥–ª—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è
                const progressBarDiv = document.createElement('div');
                progressBarDiv.id = 'finalProgressBar';
                progressBarDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #2d2d2d; border: 1px solid #444; border-radius: 8px; color: #e0e0e0;';
                progressBarDiv.innerHTML = 
                    '<h2>–§—ñ–Ω–∞–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥—ñ–∞–ª–æ–≥—É</h2>' +
                    '<div>–ü—Ä–æ–≥—Ä–µ—Å: <span id="progressPercent">0</span>%</div>' +
                    '<div style="background: #444; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 10px;">' +
                        '<div id="progressBarFill" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.5s;"></div>' +
                    '</div>' +
                    '<div id="progressStatus" style="margin-top: 10px; color: #FFA500;">–û–±—Ä–æ–±–∫–∞...</div>';
                document.body.appendChild(progressBarDiv);
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å –≤—ñ–¥ 0 –¥–æ 95% –∑–∞ 5 —Ö–≤–∏–ª–∏–Ω (300 —Å–µ–∫—É–Ω–¥)
                let progress = 0;
                const maxProgress = 95;
                const duration = 300000; // 5 —Ö–≤–∏–ª–∏–Ω –≤ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞—Ö
                const steps = 100;
                const interval = duration / steps;
                const increment = maxProgress / steps;
                
                const progressInterval = setInterval(() => {
                    progress += increment;
                    if (progress >= maxProgress) {
                        progress = maxProgress;
                        clearInterval(progressInterval);
                        document.getElementById('progressStatus').innerHTML = '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞...';
                    }
                    document.getElementById('progressPercent').textContent = Math.floor(progress);
                    document.getElementById('progressBarFill').style.width = progress + '%';
                }, interval);
                
                // –î–æ–¥–∞—î–º–æ timeout —á–µ—Ä–µ–∑ AbortController (5 —Ö–≤–∏–ª–∏–Ω)
                const timeoutMs = 300000; // 5 —Ö–≤–∏–ª–∏–Ω
                
                // POST –∑–∞–ø–∏—Ç –∑ —Ç—Ä—å–æ–º–∞ –ø–æ–ª—è–º–∏ (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—ñ –¥–ª—è –æ–±—Ö–æ–¥—É CORS)
                const postAbortController = new AbortController();
                const postTimeoutId = setTimeout(() => postAbortController.abort(), timeoutMs);
                
                let postResponse;
                try {
                    postResponse = await fetch(NODE_SERVER_URL + '/api/webhook/diarization-send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            file1Transcript: window.File1Transcript,
                            File2Transcript: window.File2Transcript,
                            'Original dialoge': window.initialDialogue
                        }),
                        signal: postAbortController.signal
                    });
                    clearTimeout(postTimeoutId);
                } catch (fetchError) {
                    clearTimeout(postTimeoutId);
                    clearInterval(progressInterval);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('Request timeout: The external service took too long to respond. Please try again.');
                    }
                    throw fetchError;
                }
                
                if (postResponse.ok) {
                    const postText = await postResponse.text();
                    let postResult = null;
                    if (postText) {
                        try {
                            postResult = JSON.parse(postText);
                        } catch (e) {
                            postResult = postText;
                        }
                    }
                    console.log('POST webhook result:', postResult);
                    
                    document.getElementById('pollingStatus').innerHTML += 
                        '<div style="color: green; margin-top: 5px;">‚úì POST –∑–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–∏–π!</div>' +
                        '<div style="color: orange; margin-top: 5px;">–í—ñ–¥–ø—Ä–∞–≤–∫–∞ GET –∑–∞–ø–∏—Ç—É...</div>';
                    
                    // –Ø–∫—â–æ POST —É—Å–ø—ñ—à–Ω–∏–π, —Ä–æ–±–∏–º–æ GET (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—ñ –¥–ª—è –æ–±—Ö–æ–¥—É CORS)
                    const getAbortController = new AbortController();
                    const getTimeoutId = setTimeout(() => getAbortController.abort(), timeoutMs);
                    
                    let getResponse;
                    try {
                        getResponse = await fetch(NODE_SERVER_URL + '/api/webhook/diarization-get', {
                            method: 'GET',
                            signal: getAbortController.signal
                        });
                        clearTimeout(getTimeoutId);
                    } catch (fetchError) {
                        clearTimeout(getTimeoutId);
                        clearInterval(progressInterval);
                        if (fetchError.name === 'AbortError') {
                            throw new Error('Request timeout: The external service took too long to respond. Please try again.');
                        }
                        throw fetchError;
                    }
                    
                    if (getResponse.ok) {
                        const getText = await getResponse.text();
                        let getResult = null;
                        if (getText) {
                            try {
                                getResult = JSON.parse(getText);
                            } catch (e) {
                                getResult = getText;
                            }
                        }
                        console.log('GET webhook result:', getResult);
                        
                        // –ó–∞–≤–µ—Ä—à—É—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä
                        clearInterval(progressInterval);
                        document.getElementById('progressPercent').textContent = '100';
                        document.getElementById('progressBarFill').style.width = '100%';
                        document.getElementById('progressStatus').innerHTML = '<span style="color: #4CAF50;">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ!</span>';
                        
                        document.getElementById('pollingStatus').innerHTML += 
                            '<div style="color: green; margin-top: 5px;">‚úì GET –∑–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–∏–π!</div>' +
                            '<div style="color: green; margin-top: 10px; font-weight: bold;">üéâ –í–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!</div>';
                        
                        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑ webhook
                        displayFinalResult(getResult);
                    } else {
                        clearInterval(progressInterval);
                        throw new Error('GET –∑–∞–ø–∏—Ç –Ω–µ –≤–¥–∞–≤—Å—è: ' + getResponse.status);
                    }
                } else {
                    clearInterval(progressInterval);
                    const errorText = await postResponse.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText };
                    }
                    throw new Error('POST –∑–∞–ø–∏—Ç –Ω–µ –≤–¥–∞–≤—Å—è: ' + postResponse.status + ' - ' + (errorData.details || errorData.error || errorText));
                }
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –Ω–∞ webhook:', error);
                clearInterval(progressInterval);
                document.getElementById('pollingStatus').innerHTML += 
                    '<div style="color: red; margin-top: 10px;">‚úó –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ webhook: ' + error.message + '</div>';
                if (document.getElementById('finalProgressBar')) {
                    document.getElementById('progressStatus').innerHTML = '<span style="color: red;">‚úó –ü–æ–º–∏–ª–∫–∞</span>';
                }
            }
        }

        function displayFinalResult(webhookResult) {
            // –°—Ç–≤–æ—Ä—é—î–º–æ –±–ª–æ–∫ –¥–ª—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∞—É–¥—ñ–æ –ø–ª–µ—î—Ä–∞
            const audioPlayerDiv = document.createElement('div');
            audioPlayerDiv.id = 'originalAudioPlayer';
            audioPlayerDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #2d2d2d; border: 1px solid #4CAF50; border-radius: 8px; color: #e0e0e0;';
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ URL –¥–ª—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∞—É–¥—ñ–æ—Ñ–∞–π–ª—É
            const audioURL = URL.createObjectURL(selectedFile);
            
            audioPlayerDiv.innerHTML = 
                '<h2 style="color: #4CAF50;">üéµ –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∞—É–¥—ñ–æ—Ñ–∞–π–ª</h2>' +
                '<div style="margin-top: 10px;">' +
                    '<div style="margin-bottom: 5px;">–§–∞–π–ª: <strong>' + selectedFile.name + '</strong></div>' +
                    '<audio controls style="width: 100%;">' +
                        '<source src="' + audioURL + '" type="' + selectedFile.type + '">' +
                        '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î audio –µ–ª–µ–º–µ–Ω—Ç.' +
                    '</audio>' +
                '</div>';
            
            document.body.appendChild(audioPlayerDiv);
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –±–ª–æ–∫ –¥–ª—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            const finalResultDiv = document.createElement('div');
            finalResultDiv.id = 'finalResult';
            finalResultDiv.style.cssText = 'margin-top: 20px; padding: 15px; background: #2d2d2d; border: 2px solid #4CAF50; border-radius: 8px; color: #e0e0e0;';
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ —â–æ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏
            let displayContent = '';
            
            if (typeof webhookResult === 'string') {
                displayContent = webhookResult;
            } else if (webhookResult && typeof webhookResult === 'object') {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä—ñ–∑–Ω—ñ –º–æ–∂–ª–∏–≤—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                if (webhookResult.response && webhookResult.response.generations && 
                    webhookResult.response.generations[0] && webhookResult.response.generations[0][0]) {
                    // LM Studio —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
                    displayContent = webhookResult.response.generations[0][0].text || '';
                } else if (webhookResult.dialogue) {
                    displayContent = webhookResult.dialogue;
                } else if (webhookResult.result) {
                    displayContent = webhookResult.result;
                } else if (webhookResult.text) {
                    displayContent = webhookResult.text;
                } else {
                    // –Ø–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑—É—î–º–æ –≤–µ—Å—å JSON
                    displayContent = JSON.stringify(webhookResult, null, 2);
                }
                
                // –û—á–∏—â–∞—î–º–æ –≤—ñ–¥ markdown –∫–æ–¥—É —è–∫—â–æ —î
                if (displayContent.includes('```')) {
                    displayContent = displayContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                }
            } else {
                displayContent = '–í—ñ–¥–ø–æ–≤—ñ–¥—å –æ—Ç—Ä–∏–º–∞–Ω–æ, –∞–ª–µ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è';
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (!displayContent || displayContent.trim() === '' || displayContent === '‚ñ°') {
                displayContent = 'LLM –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n\n–ü–æ–≤–Ω–∏–π –æ—Ç–≤–µ—Ç:\n' + JSON.stringify(webhookResult, null, 2);
            }
            
            finalResultDiv.innerHTML = 
                '<h2 style="color: #4CAF50;">üéØ –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥ webhook</h2>' +
                '<div style="background: #1a1a1a; padding: 15px; border-radius: 5px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; font-family: monospace; color: #e0e0e0; border: 1px solid #4CAF50; line-height: 1.6;">' +
                    displayContent +
                '</div>';
            
            document.body.appendChild(finalResultDiv);
            
            console.log('Final result displayed:', webhookResult);
            console.log('Display content:', displayContent);
        }
    </script>
</body>
</html>