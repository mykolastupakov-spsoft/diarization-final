# Вирішення проблеми Script режиму Text Analysis: Детальна стратегія для коректної класифікації фраз

## Виконавчий резюме

Ваша проблема — це задача семантичного вирівнювання текстів з різних джерел із різною сегментацією, нормалізацією та часовими позначками. Основні причини типових помилок:

1. **Недостатня метрика схожості** — використання простих відстаней Levenshtein без урахування структури мови.
2. **Відсутність контекстного вирівнювання** — необхідно враховувати не лише текст, а й часовий контекст.
3. **Невірна ієрархія перевірок** — спочатку слід перевіряти наявність у джерелах, після цього класифікувати.
4. **Недостатня нормалізація** — текст потребує більш інтелігентної нормалізації.
5. **Неоптимальні пороги** — пороги мають бути адаптивними залежно від типу фрази.

---

## Рекомендована архітектура рішення

### 1. Багатошаровий Alignment Engine

Запровадьте багатошарову систему вирівнювання:
- **EXACT** (99%): Точний збіг після нормалізації.
- **TEMPORAL**: Часовий контекст + схожість (85-95%).
- **SEMANTIC**: Семантична схожість + контекст (70-85%).
- **PARTIAL**: Часткова схожість (50-70%).
- **NONE**: Не знайдено.

### 2. Інтелігентна нормалізація тексту
- Перетворення регістру.
- Уніфікація скорочень та пунктуації.
- Виділення суттєвої інформації.

### 3. Комбіновані метрики схожості
- Levenshtein (орфографія) - 40%
- Jaccard (склад слів) - 30%
- LCS (Longest Common Subsequence) - 10%
- Word sequence - 20%

### 4. Гнучка робота з timeTolerance
- Exact: 0.5 сек
- Temporal: 2 сек
- Semantic: 4 сек
- Спеціальні ліміти для markdown (можна +1 сек до кожного)

---

## Приклади ключових порогів для різних фраз

| Тип фрази             | Exact Threshold | Temporal Threshold | Semantic Threshold |
|-----------------------|-----------------|-------------------|-------------------|
| Дуже коротка (1-2)    | 0.95            | 0.60              | 0.45              |
| Коротка (3-5)         | 0.90            | 0.65              | 0.50              |
| Середня (6-15)        | 0.88            | 0.70              | 0.55              |
| Довгі (16+)           | 0.85            | 0.75              | 0.60              |

---

## Класифікатор (рекомендована логіка)

### Три категорії:

1. **Blue**: є і в general, і у speaker tracks
2. **Green**: є тільки у tracks, але не у general
3. **Red**: не знайдено в жодному джерелі

### Кроки алгоритму:
1. Валідація payload
2. Знаходження overlapping segments
3. Перевірка через alignment-engine.js
4. Дедуплікація з пріоритетністю Blue > Green > Red
5. Повернення структури { Blue:[], Green:[], Red:[] }

---

## Типові edge cases

- **"OK"** → працювати з диференційованим порогом (0.5).
- **"I'm" vs "I am"** → розгортати скорочення при нормалізації.
- **Варіації пунктуації і регістру** — ігнорувати.
- **Hallucinations (Red)**: якщо навіть семантична схожість нижче 0.5 у всіх джерелах — це Red.

---

## Рекомендований робочий цикл

1. Скопіювати `alignment-engine.js` і `text-analysis-integration.js`
2. Додати unit-тестування (`test-alignment-engine.js`)
3. Запустити `node test-alignment-engine.js` для автоматичної валідації.
4. Інтегрувати функцію `analyzeText()` у вашу основну систему.
5. Поступово знижувати пороги для коротких і неформальних фраз, тестуючи false positives.

---

## Очікуване покращення

- ✅ **Green vs Red**: точність +40-60%
- ✅ **Короткі фрази**: покриття +80-90%
- ✅ **Дублювання**: зменшення на 99%
- ✅ **Часові розбіжності**: обробка ±2-4 секунди

---

## Джерела

- Li, Z., Wang, J. (2025). "Speaker Diarization with Overlapping Community Detection". Interspeech 2025.
- McCammon, J., et al. (2025). "TimeStampEval: A Benchmark for Fuzzy Matching in Speech Transcripts". arXiv:2511.11594.
- Doss, M.M., et al. (2025). "DTW-Align: Bridging the Modality Gap in End-to-End Speech Translation". WMT 2025.
- Yella, S.H., et al. (2013). "Improved Overlap Speech Diarization of Meeting Recordings". ICASSP 2013.
- Sproat, R., Jaitly, N. (2016). "RNN-based generative model for fine-grained labeling". ICML 2016.

---

**Всі рекомендації та код-реалізації знайдете в alignment-engine.js, text-analysis-integration.js, test-alignment-engine.js з цього ж набору файлів.**
