# n8n Functions Summary: Blue, Green, Red Nodes

## Огляд

Створено три JavaScript функції для n8n workflow, які аналізують результати діаризації від Speechmatics і категорізують фрагменти тексту для візуалізації на фронтенді.

## Створені файли

### 1. `n8n_function_blue_repeated_phrases.js`
**Призначення**: Знаходить фрази, які присутні і в general транскрайбі, і в окремих доріжках (speaker1/speaker2).

**Логіка**:
- Порівнює сегменти з `speaker1` та `speaker2` з сегментами з `general`
- Використовує нормалізацію тексту та Jaccard similarity для порівняння
- Повертає фрази, які знайдені в обох джерелах (повторювані)

**Вихід**: Масив об'єктів з полями:
- `speaker`, `role`, `roleLabel`
- `text`, `start`, `end`
- `source`, `confidence`, `type: "repeated"`

### 2. `n8n_function_green_overlaps.js`
**Призначення**: Знаходить моменти одночасної мови (overlaps) шляхом порівняння таймстемпів з обох доріжок.

**Логіка**:
- Порівнює таймстемпи сегментів з `speaker1` та `speaker2`
- Виявляє перекриваючі часові інтервали (overlaps)
- Обчислює тривалість перекриття

**Вихід**: Масив об'єктів з полями:
- `speaker1`: інформація про перший сегмент
- `speaker2`: інформація про другий сегмент
- `overlap`: `{ start, end, duration }`
- `type: "overlap"`

### 3. `n8n_function_red_discrepancies.js`
**Призначення**: Знаходить розбіжності та помилки транскрибації.

**Логіка**:
- Знаходить фрази, які є в окремих доріжках, але відсутні в general (`errorType: "missing"`)
- Знаходить фрази з різним текстом між general та окремими доріжками (`errorType: "transcription_error"`)
- Використовує порівняння за часом та схожістю тексту

**Вихід**: Масив об'єктів з полями:
- `speaker`, `role`, `roleLabel`
- `text`, `start`, `end`
- `errorType`: `"missing"` або `"transcription_error"`
- `description`: опис помилки
- Для `transcription_error`: `primaryText`, `similarity`

## Спільні функції

Всі три файли використовують спільні утиліти:

### `normalizeText(text)`
Нормалізує текст для порівняння:
- Перетворює в нижній регістр
- Видаляє пунктуацію
- Нормалізує пробіли

### `computeTextSimilarity(text1, text2)`
Обчислює схожість текстів:
- Перевіряє на повну ідентичність
- Перевіряє на включення (substring matching)
- Використовує Jaccard similarity на основі спільних слів

## Візуалізація на фронтенді

Результати з трьох нод об'єднуються в один JSON з ключами:

```json
{
  "Blue": [...],  // Повторювані фрази - синій колір
  "Green": [...], // Накладки - зелений колір
  "Red": [...]    // Помилки - червоний колір
}
```

## Переваги підходу

1. **Швидкість**: JavaScript функції виконуються швидко, без затримок API
2. **Вартість**: Безкоштовно, не потрібні зовнішні API
3. **Передбачуваність**: Детерміновані результати, легко тестувати
4. **Гнучкість**: Легко налаштувати пороги та параметри

## Налаштування порогів

### Blue Node
- `similarityThreshold = 0.7` - мінімальна схожість для вважання фрази повторюваною

### Green Node
- `minOverlapSeconds = 0.1` - мінімальна тривалість перекриття для виявлення overlap

### Red Node
- `similarityThreshold = 0.7` - для перевірки наявності фрази в primary
- `similarity < 0.9 && similarity >= 0.5` - діапазон для виявлення помилок транскрибації

## Використання

1. Відкрийте n8n
2. Створіть новий workflow
3. Додайте Webhook node
4. Додайте три Function nodes (Blue, Green, Red)
5. Скопіюйте код з відповідних файлів
6. Додайте Set node для об'єднання результатів
7. Додайте Webhook Response node
8. Протестуйте з `docs/json_coloring_example.json`

Детальні інструкції: `docs/n8n_workflow_setup_guide.md`

## Примітки

- Всі функції обробляють помилки та повертають структуровані відповіді
- Функції ігнорують дуже короткі фрази (< 3 символи після нормалізації)
- Результати сортуються за часом початку для зручності обробки
- Кожна функція повертає метадані зі статистикою (summary)

