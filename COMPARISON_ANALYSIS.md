# Порівняння обробки одноголосих файлів: enhance-main-speaker vs шорткати

## Ключові відмінності

### 1. Підхід до транскрипції

**enhance-main-speaker:**
- Транскрибує **весь оригінальний файл** одразу
- Отримує слова з таймстемпами відносно оригінального файлу
- Використовує `combine_diarization_and_transcription()` для об'єднання

**process_single_speaker_files_background (шорткати):**
- Розрізає аудіо на **одноголосі файли** по спікерах
- Транскрибує **кожен одноголосий файл окремо**
- Отримує слова з таймстемпами відносно одноголосого файлу (не оригінального!)

### 2. Об'єднання діаризації та транскрипції

**enhance-main-speaker:**
- Використовує `combine_diarization_and_transcription()`:
  - Об'єднує слова з транскрипції з сегментами діаризації **на рівні слів**
  - Застосовує **LLM корекції** для виправлення призначень спікерів
  - Використовує складну логіку для визначення правильного спікера для кожного слова
  - Враховує контекст, паузи, перекриття сегментів

**process_single_speaker_files_background (шорткати):**
- Просто об'єднує таймстемпи з діаризації оригінального файлу з текстом з транскрипції одноголосого файлу
- **НЕ використовує** `combine_diarization_and_transcription()`
- **НЕ застосовує LLM корекції**
- Просто зіставляє сегменти діаризації з сегментами транскрипції за індексом

### 3. Проблема з таймстемпами

**enhance-main-speaker:**
- Таймстемпи слів та сегментів діаризації відносяться до **одного і того ж файлу** (оригінального)
- Об'єднання працює правильно, бо таймстемпи синхронізовані

**process_single_speaker_files_background (шорткати):**
- Таймстемпи діаризації відносяться до **оригінального файлу**
- Таймстемпи транскрипції відносяться до **одноголосого файлу**
- При об'єднанні виникає **несинхронізація**:
  - Сегменти діаризації мають таймстемпи 0-95 секунд (оригінальний файл)
  - Сегменти транскрипції мають таймстемпи 0-30 секунд (одноголосий файл спікера 1)
  - При зіставленні за індексом отримуємо неправильні відповідності

### 4. Проблема з призначенням спікерів

**enhance-main-speaker:**
- В одноголосому файлі (якщо б він існував) був би тільки один спікер
- Але в `enhance-main-speaker` працюємо з оригінальним файлом, де є обидва спікери
- `combine_diarization_and_transcription()` правильно призначає спікерів на основі діаризації

**process_single_speaker_files_background (шорткати):**
- В одноголосому файлі спікера 1 є тільки спікер 1
- Але при об'єднанні з таймстемпами оригінальної діаризації:
  - Беремо сегменти діаризації оригінального файлу для спікера 1
  - Ці сегменти містять таймстемпи 0-95 секунд
  - Зіставляємо їх з сегментами транскрипції одноголосого файлу (0-30 секунд)
  - Отримуємо неправильне зіставлення

### 5. Визначення основного спікера

**enhance-main-speaker:**
- Визначає основного спікера на основі **об'єднаної транскрипції** (після корекцій)
- Використовує `determine_main_speaker_from_segments()` на правильних даних

**process_single_speaker_files_background (шорткати):**
- Визначає основного спікера на основі **об'єднаних сегментів** (без корекцій)
- Але сегменти об'єднані неправильно через несинхронізацію таймстемпів

## Корінь проблеми

**Основна проблема:** В шорткатах ми намагаємося об'єднати:
- Таймстемпи діаризації з **оригінального файлу** (0-95 секунд, обидва спікери)
- Текст транскрипції з **одноголосого файлу** (0-30 секунд, тільки один спікер)

Це призводить до:
1. Неправильного зіставлення сегментів (за індексом, а не за часом)
2. Можливості отримати сегменти від різних спікерів в одному одноголосому файлі
3. Неправильного визначення основного спікера для файлу

## Рішення

Потрібно використовувати **тільки транскрипцію одноголосого файлу** без об'єднання з діаризацією оригінального файлу, або правильно перетворювати таймстемпи з одноголосого файлу на таймстемпи оригінального файлу.


