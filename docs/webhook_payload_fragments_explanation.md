# Пояснення фрагментів Webhook Payload

Цей документ пояснює структуру та призначення трьох основних фрагментів JSON payload, який надсилається на webhook `http://localhost:5678/webhook/text-analysis` після завершення аналізу ролей (Step 4) та перед початком корекції overlap (Step 5).

---

## Загальна структура

Webhook payload містить чотири основні секції:

```json
{
  "general": { ... },    // Етап 1: Primary Diarization
  "speaker1": { ... },  // Етап 3: Voice Track 1 (Агент)
  "speaker2": { ... },  // Етап 3: Voice Track 2 (Клієнт)
  "markdown": "..."     // Markdown таблиця з усіх сегментів
}
```

---

## 1. Фрагмент `general` (Етап 1: Primary Diarization)

### Призначення
Містить дані з **першого етапу** обробки аудіо - первинного транскрайбу всього аудіофайлу з перекриваючими голосами.

### Коли генерується
Після завершення Step 1 (Initial Audio Analysis), коли оригінальний аудіофайл обробляється через Speechmatics з діаризацією спікерів.

### Структура

```json
{
  "general": {
    "originalText": "Hi I'm Jessica I'm calling...",  // Об'єднаний текст з усіх сегментів
    "speechmatics": {
      "success": true,
      "serviceName": "Model3",
      "engine": "speechmatics",
      "segments": [
        {
          "speaker": "SPEAKER_00",
          "text": "Hi I'm Jessica...",
          "start": 0.6,
          "end": 8.24,
          "words": [...]
        },
        // ... 34 сегменти загалом
      ],
      "rawData": {
        "service": "speechmatics",
        "jobId": "b9bmohq59a",
        "transcript": {
          "job": {
            "created_at": "2025-11-28T07:11:22.803Z",
            "data_name": "Call centre example.MP3",
            "duration": 258
          }
        }
      }
    },
    "recording": {
      "name": "Call centre example.MP3",
      "duration": null,
      "speakerCount": "2",
      "language": "en"
    },
    "segments": [...],      // Дублікат segments з speechmatics
    "segmentsCount": 34     // Кількість сегментів
  }
}
```

### Особливості
- **Містить обидва голоси одночасно** - агент і клієнт разом
- Може містити **перекриваючі сегменти** (overlap), коли обидва спікери говорять одночасно
- Транскрипція може бути **неповною або неточною** через перекриття голосів
- Використовується як **базова лінія** для порівняння з окремими доріжками

### Приклад використання
- Порівняння з окремими транскрипціями
- Визначення втрачених реплік
- Аналіз якості первинного транскрайбу

---

## 2. Фрагмент `speaker1` (Етап 3: Voice Track 1 - Агент)

### Призначення
Містить дані з **третього етапу** обробки - транскрипцію **окремої аудіодоріжки агента** (operator).

### Коли генерується
Після завершення Step 2 (Speaker Separation) та Step 3 (Voice Track Transcription):
1. Аудіо розділяється на окремі доріжки для кожного спікера
2. Доріжка агента транскрибується окремо через Speechmatics
3. Виконується аналіз ролі (Step 4) для визначення, що це агент

### Структура

```json
{
  "speaker1": {
    "speaker": "SPEAKER_00",
    "role": "operator",                    // Роль: operator (агент)
    "roleConfidence": 0.98,               // Впевненість у ролі (0-1)
    "roleSummary": "The speaker is...",   // Опис ролі
    "speechmatics": {
      "success": true,
      "serviceName": "Model3",
      "engine": "speechmatics",
      "segments": [
        {
          "speaker": "SPEAKER_00",
          "text": "Hi I'm Jessica I'm calling...",
          "start": 0.64,
          "end": 8.2,
          "pauses": [...],
          "words": [...]
        },
        // ... 29 сегментів (тільки мова агента)
      ]
    },
    "recording": {
      "name": null,
      "duration": null,
      "language": null
    },
    "segments": [...],                    // Дублікат segments з speechmatics
    "segmentsCount": 29,                  // Кількість сегментів агента
    "transcriptText": "Hi I'm Jessica..."  // Об'єднаний текст агента
  }
}
```

### Особливості
- **Містить тільки мову агента** - без перекриття з клієнтом
- Транскрипція **більш точна та повна**, оскільки аудіо вже розділено
- Може містити **залишкові сегменти клієнта** (через неідеальне розділення)
- Використовується для **порівняння з primary diarization** та виявлення втрачених реплік

### Приклад використання
- Аналіз якості транскрипції агента
- Порівняння з primary diarization для виявлення втрачених реплік
- Генерація markdown таблиці з сегментами агента

---

## 3. Фрагмент `speaker2` (Етап 3: Voice Track 2 - Клієнт)

### Призначення
Містить дані з **третього етапу** обробки - транскрипцію **окремої аудіодоріжки клієнта** (client/customer).

### Коли генерується
Після завершення Step 2 (Speaker Separation) та Step 3 (Voice Track Transcription):
1. Аудіо розділяється на окремі доріжки для кожного спікера
2. Доріжка клієнта транскрибується окремо через Speechmatics
3. Виконується аналіз ролі (Step 4) для визначення, що це клієнт

### Структура

```json
{
  "speaker2": {
    "speaker": "SPEAKER_01",
    "role": "operator",                    // ⚠️ Може бути помилка в аналізі ролі
    "roleConfidence": 0.75,                // Нижча впевненість може вказувати на помилку
    "roleSummary": "The speaker is...",
    "speechmatics": {
      "success": true,
      "serviceName": "Model3",
      "engine": "speechmatics",
      "segments": [
        {
          "speaker": "SPEAKER_01",
          "text": "Yeah Jessica I do available...",
          "start": 9.32,
          "end": 12.8,
          "words": [...]
        },
        {
          "speaker": "SPEAKER_01",
          "text": "Uh April 29th 1981",
          "start": 23.72,
          "end": 26,
          "words": [...]
        },
        // ... 34 сегменти (тільки мова клієнта)
      ]
    },
    "recording": {
      "name": "1764418405479_1_SPEAKER_01.wav",
      "duration": null,
      "language": "en"
    },
    "segments": [...],                    // Дублікат segments з speechmatics
    "segmentsCount": 34,                  // Кількість сегментів клієнта
    "transcriptText": "Hi I'm calling..."  // Об'єднаний текст клієнта
  }
}
```

### Особливості
- **Містить тільки мову клієнта** - без перекриття з агентом
- Транскрипція **більш точна та повна**, оскільки аудіо вже розділено
- Може містити **залишкові сегменти агента** (через неідеальне розділення)
- **Важливо**: Роль може бути визначена неправильно (може бути `operator` замість `client`), тому потрібно перевіряти за контекстом

### Приклад використання
- Аналіз якості транскрипції клієнта
- Порівняння з primary diarization для виявлення втрачених реплік
- Генерація markdown таблиці з сегментами клієнта

---

## 4. Фрагмент `markdown` (Markdown таблиця)

### Призначення
Містить markdown таблицю з усіх сегментів обох спікерів, відсортованих за часом.

### Коли генерується
Генерується безпосередньо перед відправкою webhook запиту, на основі сегментів з `speaker1` та `speaker2`.

### Структура

```markdown
| Segment ID | Speaker | Text | Start Time | End Time |
|------------|---------|------|------------|----------|
| 1 | Agent | Hi I'm Jessica I'm calling... | 0.64 | 8.20 |
| 2 | Agent | Hi I'm calling on behalf of | 0.68 | 2.64 |
| 3 | Agent | Yeah Jessica I do available... | 9.32 | 12.80 |
| 4 | Client | Uh April 29th 1981 | 23.72 | 26.00 |
| ... |
```

### Особливості
- Сегменти **відсортовані за часом початку** (start time)
- Мітки спікерів (`Agent`/`Client`) визначаються на основі ролей з аналізу
- Може містити **дублікати** або **неправильні призначення спікерів**
- Використовується для **візуалізації та аналізу** діалогу

---

## Порівняння етапів

| Характеристика | Етап 1 (general) | Етап 3 (speaker1/speaker2) |
|----------------|------------------|---------------------------|
| **Джерело** | Оригінальний аудіо з обома голосами | Окремі аудіодоріжки |
| **Перекриття** | Так, може бути overlap | Ні, кожна доріжка окремо |
| **Точність** | Нижча (через перекриття) | Вища (чисті доріжки) |
| **Повнота** | Може бути неповною | Більш повна |
| **Кількість сегментів** | 34 (обидва спікери) | 29 (агент) + 34 (клієнт) |
| **Використання** | Базова лінія для порівняння | Джерело для корекції |

---

## Типові випадки використання

### 1. Виявлення втрачених реплік
Порівняння `general.segments` з `speaker1.segments` та `speaker2.segments` для виявлення реплік, які були втрачені в primary diarization через overlap.

### 2. Аналіз якості транскрипції
Порівняння точності транскрипції між primary diarization та окремими доріжками.

### 3. Корекція overlap
Використання точних транскрипцій з окремих доріжок для корекції primary diarization.

### 4. Генерація фінального результату
Об'єднання найкращих сегментів з різних джерел для створення фінального транскрайбу.

---

## Важливі зауваження

1. **Ролі можуть бути визначені неправильно** - завжди перевіряйте `roleConfidence` та контекст
2. **Сегменти можуть містити залишкові голоси** - навіть після розділення
3. **Таймстемпи можуть відрізнятися** - між primary та окремими доріжками
4. **Markdown таблиця може містити помилки** - потрібна валідація та корекція

---

## Файли з прикладами

- `docs/etap1_primary_diarization_extract.json` - Приклад фрагменту `general`
- `docs/etap3_speaker1_agent_extract.json` - Приклад фрагменту `speaker1`
- `docs/etap3_speaker2_client_extract.json` - Приклад фрагменту `speaker2`

---

## Посилання

- [Webhook Payload Schema](./webhook_payload_schema.md) - Детальна схема структури
- [Project Context](./project_context.md) - Загальний контекст проекту

